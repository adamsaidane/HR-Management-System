@model HRMS.ViewModels.DashboardViewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Dashboard";
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-tachometer-alt me-2"></i>Tableau de Bord</h1>
    <div class="text-muted">
        <i class="far fa-calendar-alt me-2"></i>
        @DateTime.Now.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("fr-FR"))
    </div>
</div>

<div class="row">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <i class="fas fa-users icon text-primary"></i>
            <h3>Employés Actifs</h3>
            <div class="value text-primary">@Model.ActiveEmployees</div>
            <small class="text-muted">sur @Model.TotalEmployees total</small>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <i class="fas fa-briefcase icon text-success"></i>
            <h3>Offres Ouvertes</h3>
            <div class="value text-success">@Model.OpenJobOffers</div>
            <small class="text-muted">@Model.PendingCandidates candidats en attente</small>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <i class="fas fa-money-bill-wave icon text-warning"></i>
            <h3>Masse Salariale</h3>
            <div class="value text-warning">@Model.TotalMonthlySalary.ToString("N0") DT</div>
            <small class="text-muted">Moyenne: @Model.AverageSalary.ToString("N0") DT</small>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="stat-card">
            <i class="fas fa-laptop icon text-info"></i>
            <h3>Équipements</h3>
            <div class="value text-info">@Model.TotalEquipment</div>
            <small class="text-muted">@Model.AvailableEquipment disponibles</small>
        </div>
    </div>
</div>

<style>
    .card { border: none; border-radius: 12px; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); margin-bottom: 1.5rem; transition: all 0.3s; }
    .card:hover { box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1); }
    .card-header { background-color: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 700; color: #334155; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
    .chart-container { position: relative; height: 280px; width: 100%; }
    h4.section-title { color: #1e293b; font-weight: 800; margin: 2rem 0 1.5rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
</style>

<div class="container-fluid py-4 bg-light">

    <h4 class="section-title"><i class="fas fa-users me-2"></i>Analytique Employés</h4>
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Employés par Département</div>
                <div class="card-body"><div class="chart-container"><canvas id="deptChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Statut Professionnel</div>
                <div class="card-body"><div class="chart-container"><canvas id="statusChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Répartition par Genre</div>
                <div class="card-body"><div class="chart-container"><canvas id="genderChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Tranches d'Âge</div>
                <div class="card-body"><div class="chart-container"><canvas id="ageChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Types de Contrat</div>
                <div class="card-body"><div class="chart-container"><canvas id="contractChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Ancienneté (Années)</div>
                <div class="card-body"><div class="chart-container"><canvas id="seniorityChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Croissance des Effectifs (Par Année)</div>
                <div class="card-body"><div class="chart-container"><canvas id="growthChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-chart-line me-2"></i>Tendances d'Embauche & Départs</h4>
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Tendance d'Embauche (12 derniers mois)</div>
                <div class="card-body"><div class="chart-container"><canvas id="hiringTrendChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Tendance de Départs (12 derniers mois)</div>
                <div class="card-body"><div class="chart-container"><canvas id="terminationTrendChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Taux de Rotation du Personnel (%)</div>
                <div class="card-body"><div class="chart-container"><canvas id="turnoverChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-money-check-alt me-2"></i>Analyse Salariale & Rémunération</h4>
    <div class="row">
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header">Évolution de la Masse Salariale</div>
                <div class="card-body"><div class="chart-container"><canvas id="salaryEvolutionChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header">Salaires par Département (Moyenne)</div>
                <div class="card-body"><div class="chart-container"><canvas id="salaryDeptChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Distribution des Salaires</div>
                <div class="card-body"><div class="chart-container"><canvas id="salaryDistChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Salaire Moyen par Poste</div>
                <div class="card-body"><div class="chart-container"><canvas id="avgSalaryPosChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-gift me-2"></i>Primes & Avantages</h4>
    <div class="row">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Primes par Département (Total)</div>
                <div class="card-body"><div class="chart-container"><canvas id="bonusDeptChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">Primes par Type</div>
                <div class="card-body"><div class="chart-container"><canvas id="bonusTypeChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Utilisation des Avantages Sociaux</div>
                <div class="card-body"><div class="chart-container"><canvas id="benefitUtilChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-arrow-up me-2"></i>Promotions & Carrière</h4>
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Promotions par Département</div>
                <div class="card-body"><div class="chart-container"><canvas id="promotionDeptChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-user-tie me-2"></i>Recrutement & Candidatures</h4>
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Pipeline Candidats</div>
                <div class="card-body"><div class="chart-container"><canvas id="candidatesStageChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Offres par Département</div>
                <div class="card-body"><div class="chart-container"><canvas id="jobOfferDeptChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Résultats d'Entretiens</div>
                <div class="card-body"><div class="chart-container"><canvas id="interviewResultChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">Tendance des Candidatures (12 derniers mois)</div>
                <div class="card-body"><div class="chart-container"><canvas id="candidateAppTrendChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <h4 class="section-title"><i class="fas fa-laptop me-2"></i>Équipements & Documents</h4>
    <div class="row">
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Équipements par Type</div>
                <div class="card-body"><div class="chart-container"><canvas id="equipmentTypeChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Équipements par Statut</div>
                <div class="card-body"><div class="chart-container"><canvas id="equipmentStatusChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">Documents par Type</div>
                <div class="card-body"><div class="chart-container"><canvas id="documentTypeChart"></canvas></div></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    
    const palette = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#6f42c1', '#5a5c69', '#858796', '#fd7e14', '#20c997'];

    const setupChart = (id, type, labels, values, label = '', horizontal = false) => {
        const el = document.getElementById(id);
        if (!el) return;

        new Chart(el, {
            type: type,
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    backgroundColor: type === 'pie' || type === 'doughnut' ? palette : (type === 'line' ? 'rgba(78, 115, 223, 0.1)' : palette[0]),
                    borderColor: type === 'line' ? palette[0] : '#ffffff',
                    borderWidth: 2,
                    fill: type === 'line',
                    tension: 0.3,
                    pointRadius: 4
                }]
            },
            options: {
                indexAxis: horizontal ? 'y' : 'x',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: (type === 'pie' || type === 'doughnut'), position: 'bottom' }
                },
                scales: (type === 'pie' || type === 'doughnut') ? {} : {
                    y: { beginAtZero: true, grid: { color: '#f8f9fa' } },
                    x: { grid: { display: false } }
                }
            }
        });
    };

    // Employee Analytics
    setupChart('deptChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByDepartment.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByDepartment.Values)), 'Nombre');
    setupChart('statusChart', 'doughnut', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByStatus.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByStatus.Values)));
    setupChart('genderChart', 'pie', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByGender.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByGender.Values)));
    setupChart('ageChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByAgeRange.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByAgeRange.Values)), 'Employés');
    setupChart('contractChart', 'doughnut', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByContractType.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesByContractType.Values)));
    setupChart('seniorityChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.EmployeesBySeniority.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeesBySeniority.Values)), 'Employés');
    setupChart('growthChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.EmployeeGrowthByYear.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EmployeeGrowthByYear.Values)), 'Total Employés');

    // Hiring & Termination Trends
    setupChart('hiringTrendChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.HiringTrendByMonth.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.HiringTrendByMonth.Values)), 'Embauches');
    setupChart('terminationTrendChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.TerminationTrendByMonth.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.TerminationTrendByMonth.Values)), 'Départs');
    setupChart('turnoverChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.TurnoverRate.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.TurnoverRate.Values)), 'Taux (%)');

    // Salary Analytics
    setupChart('salaryEvolutionChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.SalaryEvolution.Select(x => x.Month))), @Html.Raw(JsonSerializer.Serialize(Model.SalaryEvolution.Select(x => x.TotalSalary))), 'Masse Salariale (DT)');
    setupChart('salaryDeptChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.SalaryByDepartment.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.SalaryByDepartment.Values)), 'Salaire (DT)', true);
    setupChart('salaryDistChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.SalaryDistribution.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.SalaryDistribution.Values)), 'Nombre d\'employés');
    setupChart('avgSalaryPosChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.AverageSalaryByPosition.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.AverageSalaryByPosition.Values)), 'Salaire Moyen (DT)', true);

    // Bonuses & Benefits
    setupChart('bonusDeptChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.BonusesByDepartment.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.BonusesByDepartment.Values)), 'Total (DT)');
    setupChart('bonusTypeChart', 'doughnut', @Html.Raw(JsonSerializer.Serialize(Model.BonusesByType.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.BonusesByType.Values)));
    setupChart('benefitUtilChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.BenefitUtilization.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.BenefitUtilization.Values)), 'Nombre d\'employés');

    // Promotions
    setupChart('promotionDeptChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.PromotionsByDepartment.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.PromotionsByDepartment.Values)), 'Nombre de promotions');

    // Recruitment
    setupChart('candidatesStageChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.CandidatesByStage.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.CandidatesByStage.Values)), 'Candidats');
    setupChart('jobOfferDeptChart', 'pie', @Html.Raw(JsonSerializer.Serialize(Model.JobOffersByDepartment.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.JobOffersByDepartment.Values)));
    setupChart('interviewResultChart', 'doughnut', @Html.Raw(JsonSerializer.Serialize(Model.InterviewSuccessRate.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.InterviewSuccessRate.Values)));
    setupChart('candidateAppTrendChart', 'line', @Html.Raw(JsonSerializer.Serialize(Model.CandidatesApplicationTrend.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.CandidatesApplicationTrend.Values)), 'Candidatures');

    // Equipment & Documents
    setupChart('equipmentTypeChart', 'pie', @Html.Raw(JsonSerializer.Serialize(Model.EquipmentByType.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EquipmentByType.Values)));
    setupChart('equipmentStatusChart', 'doughnut', @Html.Raw(JsonSerializer.Serialize(Model.EquipmentByStatus.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.EquipmentByStatus.Values)));
    setupChart('documentTypeChart', 'bar', @Html.Raw(JsonSerializer.Serialize(Model.DocumentsByType.Keys)), @Html.Raw(JsonSerializer.Serialize(Model.DocumentsByType.Values)), 'Nombre de documents');

});
</script>
}