@model dynamic
@{
    ViewData["Title"] = "Rapport Global des Salaires";
}

<div class="page-header d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1><i class="fas fa-file-invoice-dollar me-2"></i>Rapport Global des Salaires</h1>
        <p class="text-muted mb-0">Analyse détaillée des rémunérations</p>
    </div>
    <div>
        <button onclick="window.print()" class="btn btn-primary me-2">
            <i class="fas fa-print me-1"></i>Imprimer
        </button>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Retour
        </a>
    </div>
</div>

@{
    var reportData = Model as IEnumerable<dynamic>;
    var totalBaseSalary = reportData.Sum(r => (decimal)r.CurrentSalary);
    var totalBenefits = reportData.Sum(r => (decimal)r.TotalBenefits);
    var totalGross = reportData.Sum(r => (decimal)r.GrossSalary);
    var avgBaseSalary = reportData.Any() ? reportData.Average(r => (decimal)r.CurrentSalary) : 0;
    var avgGrossSalary = reportData.Any() ? reportData.Average(r => (decimal)r.GrossSalary) : 0;
}

<!-- Statistiques Globales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-money-bill icon text-primary"></i>
            <h6>Total Salaires de Base</h6>
            <h3 class="text-primary">@totalBaseSalary.ToString("N0") DT</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-gift icon text-success"></i>
            <h6>Total Avantages</h6>
            <h3 class="text-success">@totalBenefits.ToString("N0") DT</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-calculator icon text-warning"></i>
            <h6>Masse Salariale Brute</h6>
            <h3 class="text-warning">@totalGross.ToString("N0") DT</h3>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <i class="fas fa-chart-line icon text-info"></i>
            <h6>Salaire Brut Moyen</h6>
            <h3 class="text-info">@avgGrossSalary.ToString("N0") DT</h3>
        </div>
    </div>
</div>

<!-- Tableau Détaillé -->
<div class="card shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Détail par Employé</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Matricule</th>
                        <th>Employé</th>
                        <th>Département</th>
                        <th>Poste</th>
                        <th class="text-end">Salaire Base</th>
                        <th class="text-end">Avantages</th>
                        <th class="text-end">Salaire Brut</th>
                        <th class="text-end">% du Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in reportData.OrderByDescending(r => (decimal)r.GrossSalary))
                    {
                        var employee = item.Employee as HRMS.Models.Employee;
                        var baseSalary = (decimal)item.CurrentSalary;
                        var benefits = (decimal)item.TotalBenefits;
                        var gross = (decimal)item.GrossSalary;
                        var percentage = totalGross > 0 ? (gross / totalGross * 100) : 0;

                        <tr>
                            <td><strong>@employee.Matricule</strong></td>
                            <td>@employee.FullName</td>
                            <td><span class="badge bg-info">@employee.Department.Name</span></td>
                            <td>@employee.Position.Title</td>
                            <td class="text-end">@baseSalary.ToString("N2") DT</td>
                            <td class="text-end text-success">@benefits.ToString("N2") DT</td>
                            <td class="text-end"><strong>@gross.ToString("N2") DT</strong></td>
                            <td class="text-end">
                                <span class="badge bg-secondary">@percentage.ToString("N2")%</span>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="4"><strong>TOTAL</strong></td>
                        <td class="text-end"><strong>@totalBaseSalary.ToString("N2") DT</strong></td>
                        <td class="text-end"><strong class="text-success">@totalBenefits.ToString("N2") DT</strong></td>
                        <td class="text-end"><strong class="text-warning">@totalGross.ToString("N2") DT</strong></td>
                        <td class="text-end"><strong>100%</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Graphique de Distribution -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Répartition Salaires vs Avantages</h5>
            </div>
            <div class="card-body">
                <canvas id="salaryCompositionChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top 10 Salaires</h5>
            </div>
            <div class="card-body">
                <canvas id="topSalariesChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Graphique Composition
        const compositionCtx = document.getElementById('salaryCompositionChart').getContext('2d');
        new Chart(compositionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Salaires de Base', 'Avantages'],
                datasets: [{
                    data: [@totalBaseSalary, @totalBenefits],
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(75, 192, 192, 0.8)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + context.parsed.toLocaleString() + ' DT';
                            }
                        }
                    }
                }
            }
        });

        // Top 10 Salaires
        const topData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            reportData.OrderByDescending(r => (decimal)r.GrossSalary)
            .Take(10)
            .Select(r => new { 
                Name = ((HRMS.Models.Employee)r.Employee).FullName,
                Salary = (decimal)r.GrossSalary 
            })
        ));

        const topCtx = document.getElementById('topSalariesChart').getContext('2d');
        new Chart(topCtx, {
            type: 'bar',
            data: {
                labels: topData.map(d => d.Name),
                datasets: [{
                    label: 'Salaire Brut (DT)',
                    data: topData.map(d => d.Salary),
                    backgroundColor: 'rgba(255, 159, 64, 0.7)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    </script>
}